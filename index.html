<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EJK Hub - Launcher (Enhanced)</title>
    
    <link rel="manifest" href="manifest.json">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <style>
        /* 648k is the best?
 */
        /* Global & Reset */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Poppins:wght@400;600;800&display.swap');
        :root {
            --primary-color: #00ffff;
            --background-color: #0d0d0d;
            --card-background: rgba(20, 25, 40, 0.6);
            --glow-color: rgba(0, 255, 255, 0.5);
            --favorite-color: #ff4500;
            --success-color: #22c55e;
            --error-color: #ef4444;
        }
        * { box-sizing: border-box; margin: 0; padding: 0;
        }
        
        html, body {
            height: 100%;
            overflow-x: hidden;
            font-family: 'Poppins', sans-serif;
            background-color: var(--background-color);
            color: #fff;
            position: relative;
        }

        /* Particle/Canvas Background */
        #particle-canvas {
            position: fixed;
            inset: 0;
            z-index: 0;
        }

        /* Main App Structure */
        #app-container {
            position: relative;
            z-index: 10;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding-top: 20px;
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            justify-content: center;
            padding: 15px 0;
            gap: 15px;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(8px);
            border-bottom: 2px solid rgba(0,255,255,0.2);
            position: sticky;
            top: 0;
            z-index: 20;
            animation: fadeDown 0.8s ease forwards;
        }

        .tab-nav-btn {
            padding: 10px 25px;
            font-size: 1.1rem;
            font-weight: 700;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #fff;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(0,255,255,0.3);
        }

        .tab-nav-btn:hover {
            background: rgba(0,255,255,0.2);
            box-shadow: 0 0 10px var(--glow-color);
        }

        .tab-nav-btn.active {
            background: var(--primary-color);
            box-shadow: 0 0 25px var(--primary-color), 0 0 45px rgba(0, 255, 255, 0.5); 
            color: #000;
            transform: scale(1.05);
        }

        /* Views */
        .app-view {
            display: none;
            padding: 20px 0 80px;
            width: 100%;
            flex-grow: 1;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.6s ease-out, transform 0.6s ease-out;
        }
        .app-view.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            opacity: 1;
            transform: translateY(0);
        }

        /* Home View Styles */
        #home-view {
            min-height: calc(100vh - 80px);
            text-align: center;
        }
        #home-view .welcome-banner {
            font-family: 'Inter', sans-serif;
            font-size: clamp(3rem, 10vw, 8rem);
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 6px;
            margin-bottom: 50px;
            color: #fff;
            animation: pulseGlow 3s infinite ease-in-out;
            position: relative;
            cursor: pointer;
        }
         /* NEW: Style for editable welcome banner */
        #home-view .welcome-banner[contenteditable="true"] {
            outline: 2px dashed var(--primary-color);
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            cursor: text;
        }

        .home-button-group {
            display: flex;
            gap: 25px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 50px;
        }
        .home-action-button {
            padding: 15px 40px;
            font-size: 1.2rem;
            font-weight: 700;
            text-transform: uppercase;
            border: 2px solid #ffffffaa;
            color: #ffffff;
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            backdrop-filter: blur(4px);
            box-shadow: 0 0 20px rgba(255,255,255,0.2);
            transition: all 0.3s ease;
        }
        .home-action-button:hover {
            background: linear-gradient(135deg, #007bff, #00d4ff);
            border-color: transparent;
            box-shadow: 0 0 25px #00d4ff, 0 0 45px #007bff;
            transform: translateY(-4px) scale(1.05);
        }
        /* Utility classes for buttons */
        .btn-danger {
            background: var(--error-color) !important;
            color: #fff !important;
            border-color: var(--error-color) !important;
        }
        .btn-danger:hover {
            box-shadow: 0 0 25px var(--error-color);
        }
        .btn-secondary {
            background: #6c757d !important;
            color: #fff !important;
            border-color: #6c757d !important;
        }
        .btn-secondary:hover {
            box-shadow: 0 0 25px #6c757d;
        }


        .section-title {
            width: 90%;
            max-width: 1400px;
            text-align: left;
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--primary-color);
            margin: 40px 0 20px;
            padding-left: 10px;
            border-left: 4px solid var(--primary-color);
            text-shadow: 0 0 10px rgba(0,255,255,0.2);
        }
        
        .empty-state {
            color: #aaa;
            padding: 20px;
            font-style: italic;
        }

        /* Search Bar */
        .search-bar {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            width: 100%;
        }
        .search-bar input {
            width: 500px;
            max-width: 90%;
            padding: 12px 25px;
            border-radius: 30px;
            border: 1px solid rgba(0,255,255,0.3);
            outline: none;
            background: var(--card-background);
            color: #fff;
            font-size: 1rem;
            text-align: center;
            box-shadow: 0 0 15px rgba(0,255,255,0.1);
            backdrop-filter: blur(8px);
            transition: all 0.3s ease;
        }
        .search-bar input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 25px var(--glow-color);
        }

        /* Card Container */
        .content-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 30px;
            padding: 0 40px;
            width: 100%;
            max-width: 1400px;
        }
        .content-container-small {
            display: flex;
            overflow-x: auto;
            gap: 20px;
            padding: 0 40px 20px;
            width: 100%;
            max-width: 1400px;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .content-container-small::-webkit-scrollbar {
            display: none;
        }

        /* Card Styles */
        .content-card {
            background: var(--card-background);
            border-radius: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(0,255,255,0.2);
            opacity: 0;
            transform: translateY(30px) scale(0.95);
            min-width: 180px;
        }
        .content-card.visible {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
        .content-card[data-type="game"] { 
            min-width: 200px;
        }


        .card-img-container {
            width: 100%;
            height: 150px; 
            aspect-ratio: 2 / 3;
            overflow: hidden;
            border-radius: 20px 20px 0 0;
            position: relative;
        }
        .content-card[data-type="movie"] .card-img-container {
             height: auto;
        }
        
        .content-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: all 0.4s ease;
        }

        .card-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.4s ease;
            font-size: 3rem;
            color: var(--primary-color);
            text-shadow: 0 0 10px var(--glow-color);
        }
        .content-card h3 {
            padding: 15px 10px;
            font-size: 1.1rem;
            font-weight: 600;
            color: #eee;
            text-shadow: 0 0 8px rgba(0,0,0,0.5);
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .highlight {
            background-color: yellow;
            color: #000;
            padding: 0 2px;
            border-radius: 3px;
            font-weight: 700;
        }

        .content-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px var(--glow-color);
        }
        .content-card:hover img {
            transform: scale(1.05);
        }
        .content-card:hover .card-overlay {
            opacity: 1;
        }
        
        /* Favorite Heart Icon */
        .favorite-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 5;
            color: #fff;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-shadow: 0 0 5px rgba(0,0,0,0.8);
        }
        .favorite-btn.favorited {
            color: var(--favorite-color);
            text-shadow: 0 0 10px var(--favorite-color);
            animation: pulseHeart 0.5s ease;
        }
        .favorite-btn:hover {
            transform: scale(1.2);
        }
        
        /* Admin Tools Menu in Card */
        .admin-tools-btn {
            position: absolute;
            bottom: 5px;
            right: 5px;
            z-index: 5;
            color: #aaa;
            font-size: 1.2rem;
            padding: 5px;
            background: rgba(0,0,0,0.6);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            display: none;
        }
        .admin-tools-btn:hover {
            color: var(--primary-color);
        }
        .admin-tools-btn.active {
            display: block;
        }
        
        .admin-card-menu {
            position: absolute;
            bottom: 40px;
            right: 5px;
            z-index: 10;
            background: #111;
            border: 1px solid var(--primary-color);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 0 15px rgba(0,255,255,0.5);
        }
        .admin-card-menu button {
            display: block;
            width: 100%;
            padding: 8px 15px;
            text-align: left;
            background: transparent;
            color: #eee;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s ease;
        }
        .admin-card-menu button:hover {
            background: rgba(0,255,255,0.2);
        }


        /* Media Player Overlay */
        #media-player {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(5,5,5,1);
            flex-direction: column;
            z-index: 50;
            animation: playerFadeIn 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }
        #media-player iframe {
            flex: 1;
            border: none;
            width: 100%;
            height: 100%;
        }
        .player-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0,0,0,0.8);
            padding: 8px 15px;
            box-shadow: 0 0 15px rgba(0,255,255,0.15);
            backdrop-filter: blur(5px);
            position: relative;
        }
        .player-controls button {
            background: linear-gradient(90deg, #00ffff, #007bff);
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9rem;
            color: #000;
            transition: all 0.3s ease;
        }
        .player-controls button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 10px #00ffff;
        }
        .player-controls .back-btn {
             background: var(--favorite-color);
            color: #fff;
        }
        .player-controls .back-btn:hover {
            box-shadow: 0 0 10px var(--favorite-color);
        }


        /* Modal Styles */
        .app-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            z-index: 60;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.5s ease forwards;
        }
        .app-modal .modal-content {
            background: rgba(20,20,20,0.95);
            padding: 30px;
            border-radius: 12px;
            border: 1px solid var(--primary-color);
            box-shadow: 0 0 30px var(--glow-color);
            text-align: left;
            animation: fadeIn 0.8s ease forwards;
            width: 90%;
            max-width: 500px;
            position: relative;
            backdrop-filter: blur(10px);
        }
        .app-modal h3 {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-color);
            border-bottom: 1px solid #222;
            margin-bottom: 15px;
            padding-bottom: 8px;
            text-align: center;
        }
        
        /* Game Info Modal */
        #gameInfoModal .game-details p {
            margin-bottom: 8px;
            font-size: 1rem;
            line-height: 1.4;
        }
        #gameInfoModal .game-details strong {
            color: var(--primary-color);
            font-weight: 700;
        }
        #gameInfoModal .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        #gameInfoModal .modal-actions button {
            flex-grow: 1;
            font-size: 1.1rem;
        }
        
        /* NEW: Confirmation Modal */
        #confirm-modal .modal-content {
            max-width: 400px;
            text-align: center;
        }
        #confirm-message {
            font-size: 1.1rem;
            margin-bottom: 25px;
            line-height: 1.6;
        }
        .confirm-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        .confirm-actions button {
            flex: 1;
            padding: 10px 20px !important;
            font-size: 1rem !important;
        }

        /* Admin View */
        #admin-view .admin-form-container {
            width: 90%;
            max-width: 800px;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 40px;
        }
        .admin-form {
            flex: 1 1 350px;
            padding: 25px;
            background: var(--card-background);
            border-radius: 15px;
            border: 1px solid rgba(0,255,255,0.3);
            backdrop-filter: blur(5px);
        }
        .admin-form h3 {
             font-size: 1.5rem;
            color: var(--favorite-color);
             margin-bottom: 15px;
             padding-bottom: 5px;
             border-bottom: 2px solid var(--favorite-color);
        }
        /* Shared form styles for admin and edit modal */
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #555;
            background: #222;
            color: #fff;
            outline: none;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 10px var(--glow-color);
        }
        .admin-form button, #editForm button {
            width: 100%;
            margin-top: 10px;
            padding: 12px;
            font-size: 1.1rem;
        }
        .admin-error-message {
            color: var(--error-color);
            font-weight: bold;
            margin-top: 10px;
            min-height: 1.2em;
        }
        
        /* NEW: Edit Modal */
        #edit-modal .modal-content {
            max-width: 600px;
        }
        #editForm h3 {
             color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }


        /* Info View */
        #info-view {
            align-items: center;
        }
        .info-modal {
            display: flex;
            width: 90%;
            max-width: 900px;
            background: rgba(20, 25, 40, 0.8);
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.3);
            overflow: hidden;
            min-height: 450px;
            margin-top: 20px;
        }
        .info-nav {
            flex: 0 0 250px;
            background: rgba(0, 0, 0, 0.5);
            padding: 20px 0;
            border-right: 1px solid rgba(0, 255, 255, 0.2);
        }
        .info-nav button {
            display: block;
            width: 100%;
            padding: 15px 20px;
            text-align: left;
            border: none;
            background: transparent;
            color: #fff;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s ease, color 0.3s ease;
        }
        .info-nav button:hover {
            background: rgba(0, 255, 255, 0.1);
        }
        .info-nav button.active {
            background: var(--primary-color);
            color: #0d0d0d;
        }
        #infoContentArea {
            flex-grow: 1;
            padding: 30px;
        }
        
        /* Footer */
        .footer-text {
            position: fixed;
            bottom: 15px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 0.9rem;
            color: #ffffffaa;
            letter-spacing: 1px;
            z-index: 10;
        }
        
        /* NEW: Toast Notification */
        #toast-notification {
            position: fixed;
            bottom: -100px; /* Start off-screen */
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 25px;
            border-radius: 30px;
            font-weight: 600;
            color: #000;
            z-index: 100;
            transition: bottom 0.5s ease-in-out;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        #toast-notification.show {
            bottom: 30px;
        }
        #toast-notification.success {
            background-color: var(--success-color);
            box-shadow: 0 0 20px var(--success-color);
        }
        #toast-notification.error {
            background-color: var(--error-color);
            box-shadow: 0 0 20px var(--error-color);
            color: #fff;
        }


        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0;
            transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0);
            }
        }
        @keyframes fadeDown {
            from { opacity: 0;
            transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0);
            }
        }
        @keyframes pulseGlow {
            0%, 100% { text-shadow: 0 0 15px #ffffff88, 0 0 30px #ffffff44;
            }
            50% { text-shadow: 0 0 25px #ffffffcc, 0 0 60px #ffffff99;
            }
        }
        @keyframes playerFadeIn {
            from { opacity: 0;
            transform: scale(0.95); }
            to { opacity: 1; transform: scale(1);
            }
        }
        @keyframes pulseHeart {
            0% { transform: scale(1);
            }
            50% { transform: scale(1.3);
            }
            100% { transform: scale(1);
            }
        }

        /* Media Queries */
        @media (max-width: 768px) {
            #home-view .welcome-banner { font-size: 4rem;
            margin-bottom: 30px; }
            .home-button-group { flex-direction: column; gap: 15px;
            }
            .content-container { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            padding: 0 20px; }
            .content-container-small { padding: 0 20px;
            }
            #admin-view .admin-form-container { flex-direction: column;
            }
            
            .info-modal { flex-direction: column;
            min-height: 60vh;}
            .info-nav { flex: none; width: 100%;
            padding: 10px; border-right: none; border-bottom: 1px solid rgba(0, 255, 255, 0.2);
            }
            .info-nav button { padding: 10px 15px;
            }
            #infoContentArea { padding: 20px;
            }
        }

    </style>

    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8241900380607862"
      crossorigin="anonymous"></script>
</head>
<body>

    <canvas id="particle-canvas"></canvas>
    
    <div id="app-container">
        
        <div class="tab-nav">
            <button class="tab-nav-btn active" data-view="home"><i class="fas fa-home"></i> Home</button>
            <button class="tab-nav-btn" data-view="games"><i class="fas fa-gamepad"></i> Games Hub</button>
 
            <button class="tab-nav-btn" data-view="movies"><i class="fas fa-film"></i> Movies Hub</button>
            <button class="tab-nav-btn" data-view="admin"><i class="fas fa-user-shield"></i> Admin Panel</button>
            <button class="tab-nav-btn" data-view="info"><i class="fas fa-chart-bar"></i> Info</button>
        </div>

        <div id="home-view" class="app-view active">
            <h1 class="welcome-banner mt-20" id="welcome-banner" title="Click to edit name">Welcome, User!</h1>
            <div class="home-button-group">
                <button id="installAppBtn" class="home-action-button" style="display:none;"
                onclick="handleInstallPrompt()">
                    <i class="fas fa-download mr-2"></i> Install App
                </button>
                <button class="home-action-button" onclick="changeView('games')">
                    <i class="fas fa-gamepad mr-2"></i> Quick Launch Games
               
                </button>
                <button class="home-action-button" onclick="changeView('movies')">
                    <i class="fas fa-film mr-2"></i> Watch Movies
                </button>
                <button class="home-action-button" onclick="showCredits()">
                    <i class="fas 
                fa-info-circle mr-2"></i> Credits
                </button>
            </div>
            
            <h2 class="section-title"><i class="fas fa-history mr-2"></i> Recently Played</h2>
            <div class="content-container-small" id="recentlyPlayedContainer">
                 <div class="empty-state">No games played yet.
                Go play something!</div>
            </div>

            <h2 class="section-title"><i class="fas fa-heart mr-2"></i> My Favorites</h2>
            <div class="content-container-small" id="favoriteGamesContainer">
                 <div class="empty-state">Heart some games or movies to see them here!</div>
            </div>
            
        </div>

        <div id="games-view" class="app-view">
            <h2 class="section-title">Games Library</h2>
            <div class="search-bar">
         
                <input type="text" id="gameSearchInput" placeholder="Search game titles or descriptions...">
            </div>
            <div class="tabs-container mb-6 flex flex-wrap justify-center gap-2">
                <button class="tab-btn-game active home-action-button !text-sm !py-2 !px-4 !font-normal" data-category="All">All</button>
                <button class="tab-btn-game home-action-button !text-sm !py-2 !px-4 !font-normal" data-category="Sports">Sports</button>
         
                <button class="tab-btn-game home-action-button !text-sm !py-2 !px-4 !font-normal" data-category="Arcade">Arcade</button>
                <button class="tab-btn-game home-action-button !text-sm !py-2 !px-4 !font-normal" data-category="Action">Action</button>
                <button class="tab-btn-game home-action-button !text-sm !py-2 !px-4 !font-normal" data-category="Endless Runner">Endless Runner</button>
            </div>
            <div class="content-container" id="gamesContainer"></div>
        </div>

    
        <div id="movies-view" class="app-view">
            <h2 class="section-title">Movie Library</h2>
            <div class="search-bar">
                <input type="text" id="movieSearchInput" placeholder="Search movie titles or descriptions...">
            </div>
            <div class="content-container" id="moviesContainer"></div>
      
        </div>

        <div id="admin-view" class="app-view">
            <h2 class="section-title">Content Management Panel</h2>
            <p class="text-center mb-10 text-gray-400">Add new games and movies to the hub.
            Data will be saved locally in your browser.</p>
            
            <div class="admin-form-container">
                
                <form id="addGameForm" class="admin-form" onsubmit="event.preventDefault(); addContent('game', this);">
           
                    <h3>Add New Game</h3>
                    <div id="game-error" class="admin-error-message"></div>
                    <div class="form-group">
                        <label for="gameName">Name:</label>
                     
                        <input type="text" id="gameName" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="gameDescription">Description:</label>
                        <textarea id="gameDescription" name="description" 
                        rows="3" class="resize-none"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="gameUrl">Game URL:</label>
                        <input type="text" id="gameUrl" name="url" required>
    
                        </div>
                    <div class="form-group">
                        <label for="gameIcon">Icon URL (Image for card):</label>
                        <input type="url" id="gameIcon" name="icon" required>
      
                        </div>
                    <div class="form-group">
                        <label for="gameCategory">Category:</label>
                        <select id="gameCategory" name="category" required>
             
                            <option value="Sports">Sports</option>
                            <option value="Arcade">Arcade</option>
                            <option value="Action">Action</option>
                          
                            <option value="Endless Runner">Endless Runner</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <button type="submit" 
                    class="home-action-button !text-sm !font-bold">Add Game</button> 
                </form>

                <form id="addMovieForm" class="admin-form" onsubmit="event.preventDefault();
                addContent('movie', this);">
                    <h3>Add New Movie</h3>
                    <div id="movie-error" class="admin-error-message"></div>
                    <div class="form-group">
                        <label for="movieName">Name:</label>
                        <input type="text" id="movieName" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="movieDescription">Description:</label>
                        <textarea id="movieDescription" name="description" rows="3" class="resize-none"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="movieUrl">Movie/Video URL (Embed/Direct MP4):</label>
                        <input type="text" id="movieUrl" name="url" required>
                    </div>
                    <div class="form-group">
                        <label for="moviePoster">Poster URL (Image for card):</label>
                        <input type="url" id="moviePoster" name="poster" required>
                    </div>
                    <button type="submit" class="home-action-button !text-sm !font-bold">Add Movie</button>
                </form>
            </div>
        </div>

        <div id="info-view" class="app-view">
            <h2 class="section-title text-center">Hub Information</h2>
            <div id="info-modal" class="info-modal">
                <div class="info-nav">
                    <button class="info-tab-btn active" data-tab="player-counter" onclick="renderInfoModal('player-counter')">
                        <i class="fas fa-chart-line mr-2"></i> Player Sessions
                    </button>
                    <button class="info-tab-btn" data-tab="owners" onclick="renderInfoModal('owners')">
                        <i class="fas fa-users 
                    mr-2"></i> Owners & Partners
                    </button>
                </div>
                <div id="infoContentArea">
                    </div>
            </div>
        </div>

        <div id="gameInfoModal" class="app-modal" onclick="if(event.target.id === 'gameInfoModal') hideGameInfoModal()">
            <div class="modal-content" onclick="event.stopPropagation()">
                <img id="gameInfoIcon" class="w-24 h-24 object-cover rounded-lg mx-auto mb-4 border-4 border-cyan-500 shadow-lg" alt="Game Icon">
                <h3 id="gameInfoName" class="text-3xl font-extrabold mb-4"></h3>
                <div class="game-details text-gray-300">
                    <p><strong>Category:</strong> <span id="gameInfoCategory"></span></p>
                    <p><strong>Play Count:</strong> <span id="gameInfoPlayCount"></span></p>
                    <p class="mt-4 border-t border-gray-700 pt-4"><strong>Description:</strong> <br><span id="gameInfoDescription" class="italic text-sm text-gray-400"></span></p>
                </div>
                <div class="modal-actions">
                    <button id="modalPlayBtn" class="home-action-button !py-3 !px-6 !text-lg !font-bold">
                        <i class="fas fa-play mr-2"></i> Play Game
                    </button>
                    <button id="modalFavBtn" class="home-action-button !py-3 !px-6 !text-lg !font-bold !bg-transparent !border-red-500 !text-red-500 hover:!bg-red-500/20 
                    hover:!shadow-red-500/50">
                        <i class="fas fa-heart mr-2"></i> <span id="modalFavText">Add to Favorites</span>
                    </button>
                </div>
            </div>
        </div>

        <div id="media-player">
            <div class="player-controls">
                <button id="backBtn" class="back-btn"><i class="fas fa-times mr-2"></i> Exit</button>
                <span class="text-xs text-gray-400">If media is blank, check your URL format or host settings.</span>
                <button id="fullscreenBtn"><i class="fas fa-expand mr-2"></i> Fullscreen</button>
            </div>
            <iframe id="mediaFrame" allowfullscreen></iframe>
        </div>

        <div id="credit-modal" class="app-modal" onclick="if(event.target.id === 'credit-modal') hideCredits()">
            <div class="modal-content">
                <h3>Credits</h3>
                <p><strong>Design & Concept:</strong> EJK Community</p>
                <p><strong>Frontend Logic:</strong> _648k ðŸ’«</p>
                <p><strong>Particle System:</strong> Kevin (he's the best)</p>
                <button class="home-action-button w-full mt-4" onclick="hideCredits()">Close</button>
            </div>
        </div>

        <div id="edit-modal" class="app-modal" 
        onclick="if(event.target.id === 'edit-modal') hideEditModal()">
            <div class="modal-content">
                <form id="editForm" onsubmit="event.preventDefault(); handleEditSubmit(this);">
                    <h3>Edit Content</h3>
                    <div id="edit-error" class="admin-error-message"></div>
                    <input type="hidden" id="edit-id" name="id">
                    <input type="hidden" id="edit-type" name="type">
                    <div class="form-group">
                        <label for="edit-name">Name:</label>
                        <input type="text" id="edit-name" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-description">Description:</label>
                        <textarea id="edit-description" name="description" rows="3" class="resize-none"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="edit-url">Game/Movie URL:</label>
                        <input type="text" id="edit-url" name="url" required>
                    </div>
                    <div class="form-group">
                        <label id="edit-image-label" for="edit-image-url">Icon/Poster URL:</label>
                        <input type="url" id="edit-image-url" name="imageUrl" required>
                    </div>
                    <div class="form-group" id="edit-category-group">
                        <label for="edit-category">Category:</label>
                        <select id="edit-category" name="category">
                            <option value="Sports">Sports</option>
                            <option value="Arcade">Arcade</option>
                            <option value="Action">Action</option>
                            <option value="Endless Runner">Endless Runner</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <button type="submit" class="home-action-button !text-sm 
                    !font-bold">Save Changes</button>
                </form>
            </div>
        </div>

        <div id="confirm-modal" class="app-modal" onclick="if(event.target.id === 'confirm-modal') hideConfirm()">
            <div class="modal-content" onclick="event.stopPropagation()">
                <h3>Are you sure?</h3>
                <p id="confirm-message">This action cannot be undone.</p>
                <div class="confirm-actions">
                    <button id="confirm-btn-no" class="home-action-button btn-secondary">Cancel</button>
                    <button id="confirm-btn-yes" class="home-action-button btn-danger">Confirm</button>
                </div>
            </div>
        </div>

        <div id="toast-notification"></div>

        <div class="footer-text">made by the students, for the students âœ¨</div>

    </div>

    <script>
        // --- DATA MANAGEMENT & INITIALIZATION ---

        // State variables
        let username = "User";
        let contentData = {
            games: [],
            movies: []
        };
        let filters = {
            lastView: "home",
            gameCategory: "All"
        };
        let installPrompt = null;
        let adminToolsActive = false;
        let isEditing = false; // Flag to prevent re-opening admin menu on blur

        const STORAGE_KEY = 'ejkHubDataV3';

        // DOM elements
        const gamesContainer = document.getElementById('gamesContainer');
        const moviesContainer = document.getElementById('moviesContainer');
        const recentlyPlayedContainer = document.getElementById('recentlyPlayedContainer');
        const favoriteGamesContainer = document.getElementById('favoriteGamesContainer');
        const welcomeBanner = document.getElementById('welcome-banner');
        const installAppBtn = document.getElementById('installAppBtn');
        const appViews = document.querySelectorAll('.app-view');
        const navButtons = document.querySelectorAll('.tab-nav-btn');
        const gameSearchInput = document.getElementById('gameSearchInput');
        const movieSearchInput = document.getElementById('movieSearchInput');
        const toastNotification = document.getElementById('toast-notification');
        const mediaFrame = document.getElementById('mediaFrame');
        const mediaPlayer = document.getElementById('media-player');
        const gameInfoModal = document.getElementById('gameInfoModal');
        const infoContentArea = document.getElementById('infoContentArea');
        const adminToolsButtons = document.querySelectorAll('.admin-tools-btn');


        // --- PARTICLE SYSTEM ---
        const canvas = document.getElementById('particle-canvas');
        const ctx = canvas.getContext('2d');
        let particles = [];
        let mouse = { x: null, y: null, radius: 150 };
        const particleCount = 70; // Set a reasonable limit

        class Particle {
            constructor(x, y, directionX, directionY, size, color) {
                this.x = x;
                this.y = y;
                this.directionX = directionX;
                this.directionY = directionY;
                this.size = size;
                this.color = color;
            }

            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2, false);
                ctx.fillStyle = this.color;
                ctx.fill();
            }

            update() {
                if (this.x + this.size > canvas.width || this.x - this.size < 0) {
                    this.directionX = -this.directionX;
                }
                if (this.y + this.size > canvas.height || this.y - this.size < 0) {
                    this.directionY = -this.directionY;
                }

                this.x += this.directionX;
                this.y += this.directionY;

                this.interact();
                this.draw();
            }

            interact() {
                let dx = mouse.x - this.x;
                let dy = mouse.y - this.y;
                let distance = Math.sqrt(dx * dx + dy * dy);

                if (distance < mouse.radius) {
                    let forceDirectionX = dx / distance;
                    let forceDirectionY = dy / distance;
                    let maxSpeed = 1;
                    let force = (mouse.radius - distance) / mouse.radius * maxSpeed;
                    this.x -= forceDirectionX * force;
                    this.y -= forceDirectionY * force;
                }
            }
        }

        function initParticles() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            particles = [];
            for (let i = 0; i < particleCount; i++) {
                let size = (Math.random() * 2) + 1;
                let x = (Math.random() * ((canvas.width - size * 2) - (size * 2)) + size * 2);
                let y = (Math.random() * ((canvas.height - size * 2) - (size * 2)) + size * 2);
                let directionX = (Math.random() * 0.4) - 0.2; // -0.2 to 0.2
                let directionY = (Math.random() * 0.4) - 0.2; // -0.2 to 0.2
                let color = '#00ffff'; // primary color
                particles.push(new Particle(x, y, directionX, directionY, size, color));
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            ctx.fillStyle = 'rgba(13, 13, 13, 0.4)'; // Clear canvas with a trail effect
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            for (let i = 0; i < particles.length; i++) {
                particles[i].update();
            }
            connect();
        }

        function connect() {
            let opacityValue = 1;
            for (let a = 0; a < particles.length; a++) {
                for (let b = a; b < particles.length; b++) {
                    let distance = ((particles[a].x - particles[b].x) ** 2) + ((particles[a].y - particles[b].y) ** 2);
                    if (distance < (100 * 100)) {
                        opacityValue = 1 - (distance / 10000);
                        ctx.strokeStyle = `rgba(0, 255, 255, ${opacityValue})`;
                        ctx.lineWidth = 1;
                        ctx.beginPath();
                        ctx.moveTo(particles[a].x, particles[a].y);
                        ctx.lineTo(particles[b].x, particles[b].y);
                        ctx.stroke();
                    }
                }
            }
        }

        // Mouse move event for particle interaction
        window.addEventListener('mousemove', (event) => {
            mouse.x = event.x;
            mouse.y = event.y;
        });

        // Mouse leave event to stop interaction
        window.addEventListener('mouseleave', () => {
            mouse.x = null;
            mouse.y = null;
        });


        // --- LOCAL STORAGE AND DATA HANDLING ---

        const initialGames = [ { id: "game-1", name: "Basketball Stars", icon: "https://tse1.mm.bing.net/th/id/OIP.RlzsAtxQOGirwBPxPlmeXwHaE6", url: "https://d11jzht7mj96rr.cloudfront.net/games/2024/gm/basketball-stars/index.html", category: "Sports", playCount: 5, description: "Fast-paced 2-on-2 basketball action.
Test your skills against the computer or a friend! Great fun for quick breaks." }, { id: "game-2", name: "Basket Random", icon: "https://tse3.mm.bing.net/th/id/OIP.0CH4psy303aX_PqXYqbDcQAAAA", url: "https://d11jzht7mj96rr.cloudfront.com/games/2025/construct/320/basket-random-pro/index.html", category: "Sports", playCount: 8, description: "A hilarious and random physics-based basketball game.
Control two players and score with unique challenges." }, { id: "game-3", name: "Moto X3M Pool Party", icon: "https://tse3.mm.bing.net/th/id/OIP.dRzWkpSxwM2-opITBOdcKQHaE8", url: "https://d11jzht7mj96rr.cloudfront.net/games/2024/gm/moto-x3m-pool-party/index.html", category: "Sports", playCount: 15, description: "Crazy motorbike stunt game with summer-themed levels.
Perform flips and tricks to lower your time!" }, { id: "game-4", name: "Retro Bowl", icon: "https://codehs.com/uploads/307d981e1178a3ff863f0db0b0d97e75", url: "https://lonewolf454e.github.io/retro-bowl/", category: "Sports", playCount: 20, description: "Manage your American Football team and win the ultimate prize.
A simple yet addictive football sim." }, { id: "game-5", name: "Capy Clicker", icon: "https://codehs.com/uploads/4e2db92ddcc6fa88e5956dcbf3cb25d9", url: "https://d11jzht7mj96rr.cloudfront.net/games/2023/q2/capy-cutie-clicker/index.html", category: "Arcade", playCount: 5, description: "An idle clicker game where you collect points by clicking a cute capybara.
Upgrade your clicks for massive gains!" }, ]; const initialMovies = [ { id: "movie-1", name: "Dune Part 2", poster: "https://codehs.com/uploads/8043fe64a0ca8b261ce7cfa5c761235c", url: "https://www.youtube.com/embed/SY0-Q0b0h8A", description: "The second part of the sci-fi epic saga.
Highly anticipated and beautifully filmed. (Trailer link provided due to file size limits)" }, { id: "movie-2", name: "Frozen", poster: "https://codehs.com/uploads/19f46757c61797e54a82e807e769addb", url: "https://www.youtube.com/embed/TbWmHj30-3M", description: "The classic Disney animated hit.
(Trailer link provided)" }, { id: "movie-3", name: "I.T", poster: "https://codehs.com/uploads/169d03314655a406cd061428a27ded75", url: "https://www.youtube.com/embed/a70w20dO7e8", description: "A suspenseful tech thriller.
(Trailer link provided)" }, ];

        function loadContentFromStorage() {
            try {
                const serializedData = localStorage.getItem(STORAGE_KEY);
                if (serializedData) {
                    const savedData = JSON.parse(serializedData);
                    contentData = {
                        games: savedData.contentData.games || [],
                        movies: savedData.contentData.movies || []
                    };
                    username = savedData.username || "User";
                    filters = savedData.filters || { lastView: "home", gameCategory: "All" };
                }
            } catch (error) {
                console.error("Error loading data from storage:", error);
            }

            // Fallback: If no games, use initial data
            if (contentData.games.length === 0 && initialGames.length > 0) {
                contentData.games = initialGames.map(item => ({
                    ...item,
                    isFavorite: false,
                    playCount: item.playCount || 0
                }));
            }
            if (contentData.movies.length === 0 && initialMovies.length > 0) {
                contentData.movies = initialMovies.map(item => ({
                    ...item,
                    isFavorite: false
                }));
            }
            
            welcomeBanner.textContent = `Welcome, ${username}!`;
        }

        function saveContentToStorage() {
            try {
                const dataToSave = {
                    contentData: contentData,
                    username: username,
                    filters: filters
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
            } catch (error) {
                console.error("Error saving data to storage:", error);
            }
        }

        // --- GENERAL UI & VIEW MANAGEMENT ---

        function changeView(viewId) {
            appViews.forEach(view => {
                view.classList.remove('active');
            });
            navButtons.forEach(btn => {
                btn.classList.remove('active');
            });

            const targetView = document.getElementById(`${viewId}-view`);
            if (targetView) {
                targetView.classList.add('active');
                
                // Update navigation button active state
                const targetNavBtn = document.querySelector(`.tab-nav-btn[data-view="${viewId}"]`);
                if (targetNavBtn) {
                    targetNavBtn.classList.add('active');
                }

                // Update last viewed filter
                filters.lastView = viewId;
                saveContentToStorage();

                // Specific view rendering
                if (viewId === 'games') {
                    renderContent('game');
                } else if (viewId === 'movies') {
                    renderContent('movie');
                } else if (viewId === 'home') {
                    renderHomeView();
                } else if (viewId === 'info') {
                    // Default to player-counter tab on info view load
                    renderInfoModal('player-counter');
                }
            }
        }

        function showToast(message, type = 'info') {
            toastNotification.textContent = message;
            toastNotification.className = ''; // Reset classes
            toastNotification.classList.add(type);
            toastNotification.classList.add('show');
            
            setTimeout(() => {
                toastNotification.classList.remove('show');
            }, 3000); // Hide after 3 seconds
        }

        // --- CARD RENDERING ---

        function createContentCard(item, type) {
            const card = document.createElement('div');
            card.className = 'content-card';
            card.dataset.id = item.id;
            card.dataset.type = type;
            card.style.animationDelay = `${Math.random() * 0.5}s`; // Staggered entry

            const imageContainer = document.createElement('div');
            imageContainer.className = 'card-img-container';

            const img = document.createElement('img');
            img.src = type === 'game' ? item.icon : item.poster;
            img.alt = item.name;

            const overlay = document.createElement('div');
            overlay.className = 'card-overlay';
            overlay.innerHTML = `<i class="fas fa-play"></i>`;

            const title = document.createElement('h3');
            title.textContent = item.name;

            const favoriteBtn = document.createElement('i');
            favoriteBtn.className = `favorite-btn fas fa-heart`;
            if (item.isFavorite) {
                favoriteBtn.classList.add('favorited');
            }
            favoriteBtn.onclick = (e) => {
                e.stopPropagation(); // Prevent card click
                toggleFavorite(item.id, type);
            };

            const adminToolsBtn = document.createElement('i');
            adminToolsBtn.className = `admin-tools-btn fas fa-ellipsis-v`;
            adminToolsBtn.onclick = (e) => {
                e.stopPropagation();
                toggleAdminMenu(item.id, type, adminToolsBtn);
            }
            adminToolsBtn.classList.add('active'); // Always show for simplicity in this demo

            imageContainer.appendChild(img);
            imageContainer.appendChild(overlay);
            card.appendChild(imageContainer);
            card.appendChild(title);
            card.appendChild(favoriteBtn);
            card.appendChild(adminToolsBtn);

            card.onclick = () => {
                if(type === 'game') {
                    showGameInfoModal(item);
                } else {
                    playMedia(item.url, item.id);
                }
            };

            // Set to visible after append to trigger staggered animation
            setTimeout(() => {
                card.classList.add('visible');
            }, 10);

            return card;
        }

        function renderContent(type, search = '', category = 'All') {
            const container = type === 'game' ? gamesContainer : moviesContainer;
            container.innerHTML = '';
            const allItems = type === 'game' ? contentData.games : contentData.movies;

            const filteredItems = allItems.filter(item => {
                const matchesSearch = search === '' || 
                                      item.name.toLowerCase().includes(search.toLowerCase()) || 
                                      item.description.toLowerCase().includes(search.toLowerCase());
                
                const matchesCategory = type !== 'game' || category === 'All' || item.category === category;

                return matchesSearch && matchesCategory;
            });

            if (filteredItems.length === 0) {
                container.innerHTML = `<div class="empty-state">No ${type}s found matching your criteria.</div>`;
                return;
            }

            filteredItems.forEach(item => {
                container.appendChild(createContentCard(item, type));
            });

            highlightSearchTerms(container, search);
        }

        function highlightSearchTerms(container, search) {
            if (!search) return;
            const terms = search.toLowerCase().split(' ').filter(t => t.length > 1);

            container.querySelectorAll('h3').forEach(titleElement => {
                let originalHtml = titleElement.innerHTML;
                let newHtml = originalHtml;
                
                terms.forEach(term => {
                    // Create a case-insensitive regex for the term
                    const regex = new RegExp(`(${term})`, 'gi');
                    // Replace matches with the term wrapped in a highlight span
                    newHtml = newHtml.replace(regex, '<span class="highlight">$1</span>');
                });

                titleElement.innerHTML = newHtml;
            });
        }

        function renderHomeView() {
            // Render Recently Played (Top 5)
            const sortedGames = [...contentData.games].sort((a, b) => b.playCount - a.playCount);
            const recentlyPlayed = sortedGames.filter(g => g.playCount > 0).slice(0, 5);

            recentlyPlayedContainer.innerHTML = '';
            if (recentlyPlayed.length === 0) {
                 recentlyPlayedContainer.innerHTML = `<div class="empty-state">No games played yet. Go play something!</div>`;
            } else {
                recentlyPlayed.forEach(item => {
                    recentlyPlayedContainer.appendChild(createContentCard(item, 'game'));
                });
            }


            // Render Favorites (Games & Movies)
            const favoriteItems = [
                ...contentData.games.filter(g => g.isFavorite).map(g => ({...g, type: 'game'})),
                ...contentData.movies.filter(m => m.isFavorite).map(m => ({...m, type: 'movie'}))
            ];

            favoriteGamesContainer.innerHTML = '';
            if (favoriteItems.length === 0) {
                favoriteGamesContainer.innerHTML = `<div class="empty-state">Heart some games or movies to see them here!</div>`;
            } else {
                favoriteItems.forEach(item => {
                    favoriteGamesContainer.appendChild(createContentCard(item, item.type));
                });
            }
        }

        // --- INTERACTION FUNCTIONS ---

        function playMedia(url, id) {
            // Find the item to increment play count if it's a game
            const item = contentData.games.find(g => g.id === id);
            if (item) {
                item.playCount = (item.playCount || 0) + 1;
                saveContentToStorage();
            }

            mediaFrame.src = url;
            mediaPlayer.style.display = 'flex';
        }

        function exitMedia() {
            mediaFrame.src = ''; // Stop the media
            mediaPlayer.style.display = 'none';
        }

        function toggleFavorite(id, type) {
            const list = type === 'game' ? contentData.games : contentData.movies;
            const item = list.find(item => item.id === id);
            
            if (item) {
                item.isFavorite = !item.isFavorite;
                saveContentToStorage();

                // Re-render the affected views
                if (filters.lastView === 'home') {
                    renderHomeView();
                } else if (filters.lastView === 'games' && type === 'game') {
                    renderContent('game', gameSearchInput.value, filters.gameCategory);
                } else if (filters.lastView === 'movies' && type === 'movie') {
                    renderContent('movie', movieSearchInput.value);
                }

                showToast(item.isFavorite ? `${item.name} added to favorites!` : `${item.name} removed from favorites.`, 'success');
            }
        }

        // --- PWA INSTALLATION ---

        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent the default browser prompt
            e.preventDefault();
            // Stash the event so it can be triggered later.
            installPrompt = e;
            // Update UI to show the install button
            installAppBtn.style.display = 'block';
        });

        function handleInstallPrompt() {
            if (!installPrompt) return;

            // Show the prompt
            installPrompt.prompt();
            // Wait for the user to respond to the prompt
            installPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    console.log('User accepted the install prompt');
                } else {
                    console.log('User dismissed the install prompt');
                }
                installPrompt = null;
                installAppBtn.style.display = 'none'; // Hide button regardless of choice
            });
        }

        // --- GAME INFO MODAL ---

        function showGameInfoModal(game) {
            document.getElementById('gameInfoIcon').src = game.icon;
            document.getElementById('gameInfoName').textContent = game.name;
            document.getElementById('gameInfoCategory').textContent = game.category;
            document.getElementById('gameInfoPlayCount').textContent = game.playCount;
            document.getElementById('gameInfoDescription').textContent = game.description;

            const modalPlayBtn = document.getElementById('modalPlayBtn');
            modalPlayBtn.onclick = () => {
                playMedia(game.url, game.id);
                hideGameInfoModal();
            };

            const modalFavBtn = document.getElementById('modalFavBtn');
            const modalFavText = document.getElementById('modalFavText');
            modalFavBtn.classList.toggle('favorited', game.isFavorite);
            modalFavText.textContent = game.isFavorite ? "Remove Favorite" : "Add to Favorites";

            modalFavBtn.onclick = () => {
                toggleFavorite(game.id, 'game');
                // Update modal view right away
                modalFavBtn.classList.toggle('favorited', !game.isFavorite);
                modalFavText.textContent = !game.isFavorite ? "Remove Favorite" : "Add to Favorites";
            };

            gameInfoModal.style.display = 'flex';
        }

        function hideGameInfoModal() {
            gameInfoModal.style.display = 'none';
        }

        // --- ADMIN MENU FUNCTIONS (DELETE/EDIT) ---
        
        // Closes all admin menus when clicking anywhere else
        function handleGlobalClick(e) {
             // If we are currently editing, do nothing
            if (isEditing) return;

            // Check if the click is outside any admin tool button or menu
            if (!e.target.closest('.admin-tools-btn') && !e.target.closest('.admin-card-menu')) {
                document.querySelectorAll('.admin-card-menu').forEach(menu => menu.remove());
                adminToolsActive = false;
                document.removeEventListener('click', handleGlobalClick);
            }
        }

        function toggleAdminMenu(id, type, button) {
            // Remove any existing menu first
            document.querySelectorAll('.admin-card-menu').forEach(menu => menu.remove());
            document.removeEventListener('click', handleGlobalClick);

            // Create the new menu
            const menu = document.createElement('div');
            menu.className = 'admin-card-menu';
            menu.dataset.id = id;
            menu.dataset.type = type;

            const editBtn = document.createElement('button');
            editBtn.innerHTML = `<i class="fas fa-edit mr-2"></i> Edit`;
            editBtn.onclick = (e) => {
                e.stopPropagation();
                showEditModal(id, type);
                menu.remove();
            };

            const deleteBtn = document.createElement('button');
            deleteBtn.innerHTML = `<i class="fas fa-trash-alt mr-2"></i> Delete`;
            deleteBtn.onclick = (e) => {
                e.stopPropagation();
                showConfirm(
                    `Are you sure you want to delete **${contentData[type + 's'].find(i => i.id === id).name}**? This cannot be undone.`,
                    () => deleteContent(id, type)
                );
                menu.remove();
            };

            menu.appendChild(editBtn);
            menu.appendChild(deleteBtn);

            button.parentElement.appendChild(menu);
            adminToolsActive = true;
            
            // Add global listener to close menu on outside click
            // Use a timeout to allow the current click event to complete before the listener is active
            setTimeout(() => {
                 document.addEventListener('click', handleGlobalClick);
            }, 10);
           
        }

        function deleteContent(id, type) {
            const list = contentData[type + 's'];
            const index = list.findIndex(item => item.id === id);

            if (index > -1) {
                const name = list[index].name;
                list.splice(index, 1);
                saveContentToStorage();
                
                // Re-render the current view
                if (type === 'game' && filters.lastView === 'games') {
                     renderContent('game', gameSearchInput.value, filters.gameCategory);
                } else if (type === 'movie' && filters.lastView === 'movies') {
                    renderContent('movie', movieSearchInput.value);
                } else if (filters.lastView === 'home') {
                    renderHomeView();
                }

                showToast(`${name} deleted successfully!`, 'success');
            }
        }

        // --- ADMIN FORM SUBMISSION (ADD) ---

        function addContent(type, form) {
            const list = contentData[type + 's'];
            const name = form.name.value.trim();
            const url = form.url.value.trim();
            const iconOrPoster = type === 'game' ? form.icon.value.trim() : form.poster.value.trim();
            const description = form.description.value.trim();
            const category = type === 'game' ? form.category.value : undefined;
            const errorElement = document.getElementById(`${type}-error`);

            errorElement.textContent = ''; // Clear previous errors

            if (!name || !url || !iconOrPoster) {
                 errorElement.textContent = 'Name, URL, and Image URL/Poster are required.';
                 showToast('Please fill out all required fields.', 'error');
                 return;
            }

            // Simple check to prevent duplicates
            if (list.some(item => item.name.toLowerCase() === name.toLowerCase())) {
                errorElement.textContent = `${name} already exists.`;
                showToast('Content with this name already exists.', 'error');
                return;
            }

            const newItem = {
                id: `${type}-${Date.now()}`, // Simple unique ID
                name: name,
                url: url,
                description: description,
                isFavorite: false
            };

            if (type === 'game') {
                newItem.icon = iconOrPoster;
                newItem.category = category;
                newItem.playCount = 0;
            } else {
                newItem.poster = iconOrPoster;
            }

            list.push(newItem);
            saveContentToStorage();
            form.reset(); // Clear form inputs
            showToast(`${name} added to the hub!`, 'success');

            // Re-render the respective view if active
            if (filters.lastView === type + 's') {
                renderContent(type, type === 'game' ? gameSearchInput.value : movieSearchInput.value, filters.gameCategory);
            }
        }


        // --- EDIT MODAL FUNCTIONS ---
        const editModal = document.getElementById('edit-modal');
        const editForm = document.getElementById('editForm');
        const editCategoryGroup = document.getElementById('edit-category-group');

        function showEditModal(id, type) {
            isEditing = true;
            document.querySelectorAll('.admin-card-menu').forEach(menu => menu.remove()); // Close any open menus

            const list = contentData[type + 's'];
            const item = list.find(i => i.id === id);

            if (!item) {
                showToast(`Could not find item with ID: ${id}`, 'error');
                isEditing = false;
                return;
            }

            // Set hidden fields
            document.getElementById('edit-id').value = id;
            document.getElementById('edit-type').value = type;

            // Populate common fields
            document.getElementById('edit-name').value = item.name;
            document.getElementById('edit-description').value = item.description;
            document.getElementById('edit-url').value = item.url;
            
            // Handle type-specific fields
            const editImageLabel = document.getElementById('edit-image-label');
            const editImageUrl = document.getElementById('edit-image-url');

            if (type === 'game') {
                editImageLabel.textContent = 'Icon URL:';
                editImageUrl.value = item.icon;
                document.getElementById('edit-category').value = item.category;
                editCategoryGroup.style.display = 'block';
            } else { // movie
                editImageLabel.textContent = 'Poster URL:';
                editImageUrl.value = item.poster;
                editCategoryGroup.style.display = 'none';
            }
            
            document.getElementById('edit-error').textContent = '';
            editModal.style.display = 'flex';
        }
        
        function hideEditModal() {
            editModal.style.display = 'none';
            isEditing = false;
        }

        function handleEditSubmit(form) {
             const id = form['edit-id'].value;
             const type = form['edit-type'].value;
             const list = contentData[type + 's'];
             const item = list.find(i => i.id === id);
             const errorElement = document.getElementById('edit-error');

            errorElement.textContent = '';
             if (!item) {
                 errorElement.textContent = 'Error: Content not found.';
                 showToast('Error saving changes.', 'error');
                 return;
             }
             
             const newName = form['edit-name'].value.trim();
             const newUrl = form['edit-url'].value.trim();
             const newImage = form['edit-image-url'].value.trim();
             
             if (!newName || !newUrl || !newImage) {
                 errorElement.textContent = 'Name, URL, and Image URL/Poster are required.';
                 showToast('Please fill out all required fields.', 'error');
                 return;
             }

             // Update the item
             item.name = newName;
             item.description = form['edit-description'].value.trim();
             item.url = newUrl;
             
             if (type === 'game') {
                 item.icon = newImage;
                 item.category = form['edit-category'].value;
             } else {
                 item.poster = newImage;
             }

             saveContentToStorage();
             hideEditModal();
             showToast(`${item.name} updated successfully!`, 'success');

             // Re-render the affected views
             if (filters.lastView === type + 's') {
                renderContent(type, type === 'game' ? gameSearchInput.value : movieSearchInput.value, filters.gameCategory);
             } else if (filters.lastView === 'home') {
                 renderHomeView();
             }
        }
        
        // --- CONFIRMATION MODAL ---
        const confirmModal = document.getElementById('confirm-modal');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmBtnYes = document.getElementById('confirm-btn-yes');
        const confirmBtnNo = document.getElementById('confirm-btn-no');

        function showConfirm(message, onConfirmCallback) {
            confirmMessage.innerHTML = message;
            confirmModal.style.display = 'flex';

            confirmBtnYes.onclick = () => {
                onConfirmCallback();
                hideConfirm();
            };
            
            confirmBtnNo.onclick = () => {
                hideConfirm();
            };
        }

        function hideConfirm() {
             confirmModal.style.display = 'none';
        }
        
        // --- INFO MODAL CONTENT ---
        function renderInfoModal(tab) {
            const tabs = document.querySelectorAll('.info-tab-btn');
            tabs.forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.info-tab-btn[data-tab="${tab}"]`).classList.add('active');

            if (tab === 'player-counter') {
                const totalPlays = contentData.games.reduce((sum, game) => sum + game.playCount, 0);
                const mostPlayed = [...contentData.games].sort((a, b) => b.playCount - a.playCount)[0];

                let mostPlayedHtml = 'No games have been played yet.';
                if (mostPlayed && mostPlayed.playCount > 0) {
                    mostPlayedHtml = `The current **most played game** is **${mostPlayed.name}** with **${mostPlayed.playCount}** sessions.`;
                }

                infoContentArea.innerHTML = `
                    <h3 class="text-2xl font-bold mb-4">Player Sessions Statistics</h3>
                    <div class="space-y-4 text-lg">
                        <p class="p-3 rounded-lg bg-gray-800 border-l-4 border-cyan-500">
                            Total Game Sessions tracked: <span class="text-3xl font-extrabold text-cyan-400 ml-2">${totalPlays}</span>
                        </p>
                        <p class="p-3 rounded-lg bg-gray-800 border-l-4 border-cyan-500">
                            Total Unique Games: <span class="text-xl font-bold text-cyan-400 ml-2">${contentData.games.length}</span>
                        </p>
                        <p class="p-3 rounded-lg bg-gray-800 border-l-4 border-cyan-500">
                            ${mostPlayedHtml}
                        </p>
                    </div>
                `;
            } else if (tab === 'owners') {
                 infoContentArea.innerHTML = `
                    <h3 class="text-2xl font-bold mb-4">Owners & Partners</h3>
                    <div class="space-y-4 text-lg">
                        <p class="p-3 rounded-lg bg-gray-800 border-l-4 border-red-500">
                            **Owner/Lead Developer:** _648k
                        </p>
                        <p class="p-3 rounded-lg bg-gray-800 border-l-4 border-red-500">
                            **Design & Concept:** EJK Community
                        </p>
                        <p class="p-3 rounded-lg bg-gray-800 border-l-4 border-red-500">
                            **Major Contributors:** <ul class="list-disc list-inside ml-4 mt-2 text-sm text-gray-400">
                                <li>Kevin (Particle System)</li>
                                <li>The entire EJK Student Body (Testing & Feedback)</li>
                            </ul>
                        </p>
                        <p class="p-3 mt-5 text-sm italic text-gray-400">
                            This hub is a student-made project, built for educational and recreational purposes within the community.
                        </p>
                    </div>
                `;
            }
        }
        
        function showCredits() {
            document.getElementById('credit-modal').style.display = 'flex';
        }
        
        function hideCredits() {
            document.getElementById('credit-modal').style.display = 'none';
        }

        // --- EVENT LISTENERS ---

        navButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                changeView(btn.dataset.view);
            });
        });

        // Search inputs
        gameSearchInput.addEventListener('input', (e) => {
            renderContent('game', e.target.value, filters.gameCategory);
        });

        movieSearchInput.addEventListener('input', (e) => {
            renderContent('movie', e.target.value);
        });

        // Game Category Tabs
        document.getElementById('games-view').addEventListener('click', (e) => {
            if (e.target.classList.contains('tab-btn-game')) {
                document.querySelectorAll('.tab-btn-game').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                filters.gameCategory = e.target.dataset.category;
                saveContentToStorage();
                renderContent('game', gameSearchInput.value, filters.gameCategory);
            }
        });

        // Media Player controls
        document.getElementById('backBtn').addEventListener('click', exitMedia);
        document.getElementById('fullscreenBtn').addEventListener('click', () => {
             mediaFrame.requestFullscreen();
        });


        // --- APPLICATION STARTUP ---

        document.addEventListener('DOMContentLoaded', () => {
             loadContentFromStorage();
             initParticles();
             animate();
             
             const initialView = filters.lastView;
             changeView(initialView);
             
             // --- NEW: Listeners for editable welcome banner ---
             welcomeBanner.addEventListener('click', () => {
                if(document.querySelector('.app-view.active')?.id === 'home-view') {
                    welcomeBanner.contentEditable = true;
                    welcomeBanner.focus();
                    document.execCommand('selectAll', false, null);
                }
             });
             
             welcomeBanner.addEventListener('blur', () => {
                welcomeBanner.contentEditable = false;
                const newName = welcomeBanner.textContent.replace('Welcome,', '').replace('!', '').trim();
                username = newName || 'User'; // Fallback
                welcomeBanner.textContent = `Welcome, ${username}!`;
                saveContentToStorage();
                showToast('Username updated!', 'success');
             });
             
             welcomeBanner.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    welcomeBanner.blur();
                }
             });
        });
        window.addEventListener('resize', initParticles);
        
        // Global click handler is now added/removed by toggleAdminMenu
        
    </script>
</body>
</html>
